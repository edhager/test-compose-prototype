{"version":3,"file":"aspect.js","sourceRoot":"","sources":["aspect.ts"],"names":["AdviceType","getDispatcher","getDispatcher.dispatcher","advise","before","after","around"],"mappings":"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","sourcesContent":["import WeakMap from 'dojo-core/WeakMap';\r\n\r\nexport interface AdvisingFunction extends Function {\r\n\tnext: AdvisingFunction;\r\n\tprevious: AdvisingFunction;\r\n}\r\n\r\nexport interface DispatchAdvice<T> {\r\n\tbefore?: BeforeAdvice[];\r\n\tafter?: AfterAdvice<T>[];\r\n\tjoinPoint: Function;\r\n}\r\n\r\nexport interface BeforeAdvice {\r\n    (...args: any[]): any[] | void;\r\n}\r\n\r\nexport interface AfterAdvice<T> {\r\n    (result: T, ...args: any[]): T;\r\n}\r\n\r\nexport interface AroundAdvice<T> {\r\n    (origFn: GenericFunction<T>): (...args: any[]) => T;\r\n}\r\n\r\nexport enum AdviceType { Before, After, Around };\r\n\r\nconst dispatchAdviceMap = new WeakMap<Function, DispatchAdvice<any>>();\r\n\r\nexport interface GenericFunction<T> {\r\n\t(...args: any[]): T;\r\n}\r\n\r\nfunction getDispatcher<T>(joinPoint: GenericFunction<T>): GenericFunction<T> {\r\n\r\n\tfunction dispatcher(...args: any[]): T {\r\n\t\tconst adviceMap = dispatchAdviceMap.get(dispatcher);\r\n\t\tif (adviceMap.before) {\r\n\t\t\targs = adviceMap.before.reduce((previousArgs, advice) => {\r\n\t\t\t\tconst currentArgs = advice.apply(this, previousArgs);\r\n\t\t\t\treturn currentArgs ? currentArgs : previousArgs;\r\n\t\t\t}, args);\r\n\t\t}\r\n\t\tlet result = adviceMap.joinPoint.apply(this, args);\r\n\t\tif (adviceMap.after) {\r\n\t\t\tresult = adviceMap.after.reduce((previousResult, advice) => {\r\n\t\t\t\treturn advice.apply(this, [ previousResult ].concat(args));\r\n\t\t\t}, result);\r\n\t\t}\r\n\t\treturn result;\r\n\t}\r\n\r\n\tdispatchAdviceMap.set(dispatcher, {\r\n\t\tjoinPoint: joinPoint\r\n\t});\r\n\r\n\treturn dispatcher;\r\n}\r\n\r\nfunction advise<T>(joinPoint: GenericFunction<T>, type: AdviceType, advice: BeforeAdvice|AfterAdvice<T>|AroundAdvice<T>): GenericFunction<T> {\r\n\tlet dispatcher: GenericFunction<any> = joinPoint;\r\n\tif (type === AdviceType.Around) {\r\n\t\tdispatcher = getDispatcher(advice.apply(this, [ joinPoint ]));\r\n\t}\r\n\telse {\r\n\t\tif (!dispatchAdviceMap.has(joinPoint)) {\r\n\t\t\tdispatcher = getDispatcher(joinPoint);\r\n\t\t}\r\n\t\tconst adviceMap = dispatchAdviceMap.get(dispatcher);\r\n\t\tif (type === AdviceType.Before) {\r\n\t\t\t(adviceMap.before || (adviceMap.before = [])).unshift(<BeforeAdvice> advice);\r\n\t\t}\r\n\t\telse {\r\n\t\t\t(adviceMap.after || (adviceMap.after = [])).push(<AfterAdvice<T>> advice);\r\n\t\t}\r\n\t}\r\n\treturn dispatcher;\r\n}\r\n\r\nexport function before<T>(joinPoint: GenericFunction<T>, advice: BeforeAdvice): GenericFunction<T> {\r\n\treturn advise(joinPoint, AdviceType.Before, advice);\r\n}\r\n\r\nexport function after<T>(joinPoint: GenericFunction<T>, advice: AfterAdvice<T>): GenericFunction<T> {\r\n\treturn advise(joinPoint, AdviceType.After, advice);\r\n}\r\n\r\nexport function around<T>(joinPoint: GenericFunction<T>, advice: AroundAdvice<T>): GenericFunction<T> {\r\n\treturn advise<T>(joinPoint, AdviceType.Around, advice);\r\n}\r\n"]}